name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
  schedule:
    # Monday at 15:18 UTC
    - cron: "18 15 * * MON"

jobs:
  base:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Supported stable versions
        python-version: ["3.13", "3.12", "3.11", "3.10"]

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Prepare Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: .github/workflows/install_deps.sh base R

      - name: Run tests
        timeout-minutes: 15
        run: tox -e base

      - name: Run visualization tests
        timeout-minutes: 5
        run: tox -e visualization

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml

  external:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Prepare Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: "1.11"

      - name: Install dependencies
        run: .github/workflows/install_deps.sh base R

      - name: Run external (R) tests
        timeout-minutes: 20
        run: tox -e external-R

      - name: Run external (Julia/COPASI) tests
        timeout-minutes: 20
        run: tox -e external-other-simulators

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml

  petab:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Prepare Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: .github/workflows/install_deps.sh amici

      - name: Run tests
        timeout-minutes: 30
        run: tox -e petab

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml

  mac:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Prepare Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: .github/workflows/install_deps.sh base

      - name: Run tests
        timeout-minutes: 15
        run: tox -e mac

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml

  notebooks1:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Prepare Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: .github/workflows/install_deps.sh base

      - name: Run notebooks
        timeout-minutes: 20
        run: tox -e notebooks1

  notebooks2:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Prepare Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: .github/workflows/install_deps.sh R amici

      - name: Run notebooks
        timeout-minutes: 20
        run: tox -e notebooks2

  quality:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Prepare Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          .github/workflows/install_deps.sh doc
          python -m pip install -U pip
          python -m pip install tox

      - name: Preview Ruff linting
        timeout-minutes: 5
        run: tox -e lint
        continue-on-error: true

      - name: Run quality checks
        timeout-minutes: 10
        run: tox -e project,flake8

      - name: Build docs
        timeout-minutes: 10
        run: tox -e doc

      - name: Test migration
        timeout-minutes: 10
        run: tox -e migrate

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
